<!DOCTYPE html>
<html lang="en" ng-app="cartApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="StoryStyles.css">
</head>
<body ng-controller="CartController">
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="HomePage.html">Storytellers</a>
            <button class="btn btn-outline-dark" onclick="location.href='ShoppingCart.html'">
                <img src="Assets/cart.jpg" alt="Cart" width="30" height="30">
            </button>
        </nav>
    </header>

    <section class="cart-section container">
        <h2>Your Shopping Cart</h2>
        <div class="cart-table">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Items</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="(productId, item) in cart">
                        <td>{{ item.productDescription }}</td>
                        <td>${{ item.productPrice.toFixed(2) }}</td>
                        <td>
                            <input type="number" class="form-control quantity-select" ng-model="item.quantity" min="1"
                                ng-change="updateQuantity(productId, item.quantity)">
                        </td>
                        <td>${{ (item.productPrice * item.quantity).toFixed(2) }}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" ng-click="removeFromCart(productId)">Remove</button>
                        </td>
                    </tr>
                    <tr ng-if="!Object.keys(cart).length">
                        <td colspan="5" class="text-center">Your Shopping Cart is Empty!</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="order-summary">
            <h5>Order Summary</h5>
            <p><strong>Subtotal:</strong> ${{ calculateSubtotal().toFixed(2) }}</p>
            <button class="btn btn-danger btn-block" ng-click="checkout()">Proceed to Checkout</button>
        </div>

        <div class="search-section mt-5">
            <h3>Find Books</h3>
            <input type="text" class="form-control" ng-model="searchTerm" placeholder="Search for books...">
            <button class="btn btn-outline-dark mt-2" ng-click="search()">Search</button>
            <div class="mt-4">
                <div class="search-result" ng-repeat="product in searchResults">
                    <p><strong>{{ product.productDescription }}</strong> - ${{ product.productPrice.toFixed(2) }}</p>
                    <button class="btn btn-outline-dark" ng-click="addToCart(product.productId)">Add to Cart</button>
                </div>
            </div>
        </div>
    </section>

    <footer class="text-center bg-dark text-white py-4">
        <p>&copy; 2024 Storytellers. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

    <script>
        var app = angular.module('cartApp', []);

        app.controller('CartController', ['$scope', '$http', function($scope, $http) {
            $scope.cart = {};
            $scope.products = {};
            $scope.searchResults = [];
            $scope.searchTerm = '';

            // Load products
            $http.get('/api/products').then(function(response) {
                $scope.products = response.data;
            });

            // Load cart
            $http.get('/api/cart').then(function(response) {
                $scope.cart = response.data;
            });

            // Add to cart
            $scope.addToCart = function(productId) {
                const product = $scope.products[productId];
                if ($scope.cart[productId]) {
                    $scope.cart[productId].quantity += 1;
                } else {
                    $scope.cart[productId] = {
                        productDescription: product.productDescription,
                        productPrice: product.productPrice,
                        quantity: 1
                    };
                }

                $http.post('/api/cart', { productId: productId, quantity: 1 }).then(function(response) {
                    $scope.cart = response.data;
                });
            };

            // Update quantity
            $scope.updateQuantity = function(productId, quantity) {
                if (quantity <= 0) {
                    $scope.removeFromCart(productId);
                    return;
                }

                $scope.cart[productId].quantity = quantity;
                $http.put(`/api/cart/${productId}`, { quantity: quantity }).then(function(response) {
                    $scope.cart = response.data;
                });
            };

            // Remove from cart
            $scope.removeFromCart = function(productId) {
                delete $scope.cart[productId];
                $http.delete(`/api/cart/${productId}`).then(function() {
                    $scope.cart = $scope.cart;
                });
            };

            // Calculate subtotal
            $scope.calculateSubtotal = function() {
                return Object.values($scope.cart).reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
            };

            // Search functionality
            $scope.search = function() {
                const searchTerm = $scope.searchTerm.toLowerCase();
                $scope.searchResults = Object.values($scope.products).filter(product =>
                    product.productDescription.toLowerCase().includes(searchTerm)
                );
            };

            // Checkout
            $scope.checkout = function() {
                window.location.href = 'ShippingSelection.html';
            };
        }]);
    </script>
</body>
</html>
