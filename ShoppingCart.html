<!DOCTYPE html>
<html lang="en" ng-app="cartApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="StoryStyles.css">
    <style>
        .cart-section {
            padding: 30px 0;
        }
        .cart-empty {
            text-align: center;
            padding: 20px;
        }
        .order-summary {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
        }
        .quantity-select {
            width: 60px;
        }
    </style>
</head>
<body ng-controller="CartController">
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="HomePage.html">Storytellers</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item"><a class="nav-link" href="#">Fiction</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Nonfiction</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Teens and Young Adult</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">About Us</a></li>
                </ul>
                <button class="btn btn-primary mr-2" onclick="location.href='AdminLogin.html'">Admin Login</button>
                <button class="btn btn-outline-dark" onclick="location.href='ShoppingCart.html'">
                    <img src="Assets/cart.jpg" alt="Cart" width="30" height="30">
                </button>
            </div>
        </nav>
    </header>

    <section class="cart-section container">
        <h2>Your Shopping Cart</h2>
        <div class="cart-table">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Items</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="cartItems">
                    <tr ng-repeat="(productId, item) in cart">
                        <td>{{ item.product.productDescription }}</td>
                        <td>${{ item.product.productPrice.toFixed(2) }}</td>
                        <td>
                            <input type="number" class="form-control quantity-select" ng-model="item.quantity" min="1" ng-change="updateCartItem(productId, item.quantity)">
                        </td>
                        <td>${{ (item.product.productPrice * item.quantity).toFixed(2) }}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" ng-click="removeCartItem(productId)">Remove</button>
                        </td>
                    </tr>
                    <tr ng-if="!Object.keys(cart).length">
                        <td colspan="5" class="cart-empty">Your Shopping Cart is Empty!</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="order-summary">
            <h5>Order Summary</h5>
            <p><strong>Subtotal:</strong> ${{ getSubtotal() }}</p>
            <p><strong>Shipping:</strong> Determined in Checkout</p>
            <p><strong>Estimated Total:</strong> ${{ getSubtotal() }}</p>
            <button class="btn btn-danger btn-block" ng-disabled="!Object.keys(cart).length" ng-click="proceedToCheckout()">Proceed to Checkout</button>
        </div>

        <div class="search-section mt-5">
            <h3>Find Books</h3>
            <input type="text" class="form-control" id="searchBar" placeholder="Search for books...">
            <button class="btn btn-outline-dark mt-2" id="searchButton">Search</button>
            <div id="searchResults" class="mt-4"></div>
        </div>
    </section>

    <footer class="text-center bg-dark text-white py-4">
        <p>&copy; 2024 Storytellers. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script>
        var app = angular.module('cartApp', []);
        app.controller('CartController', ['$scope', '$http', function($scope, $http) {
            $scope.cart = {};
            $scope.products = {};

            // Load products and cart
            $http.get('api/Products.json').then(function(response) {
                $scope.products = response.data;
                $('#searchButton').click();
            });

            $http.get('api/ShoppingCartItems.json').then(function(response) {
                $scope.cart = response.data;
            });

            // Update cart item
            $scope.updateCartItem = function(productId, quantity) {
                if (quantity <= 0) {
                    delete $scope.cart[productId];
                } else {
                    $scope.cart[productId].quantity = quantity;
                }
                $scope.saveCart();
            };

            $scope.addToCart = function(productId) {
                if ($scope.cart[productId]) {
                    $scope.cart[productId].quantity += 1;
                } else {
                    $scope.cart[productId] = { product: $scope.products[productId], quantity: 1 };
                }
                $scope.saveCart();
            };

            $scope.removeCartItem = function(productId) {
                delete $scope.cart[productId];
                $scope.saveCart();
            };

            // Save cart to JSON file
            $scope.saveCart = function() {
                $http.post('/api/shopping-cart', $scope.cart);
            };

            // Order summary
            $scope.getSubtotal = function() {
                let subtotal = 0;
                angular.forEach($scope.cart, function(item) {
                    subtotal += item.product.productPrice * item.quantity;
                });
                return subtotal.toFixed(2);
            };

            $scope.proceedToCheckout = function() {
                window.location.href = 'ShippingSelection.html';
            };
        }]);

        // jQuery for search functionality
        $(document).ready(function() {
            $('#searchButton').click(function() {
                const searchTerm = $('#searchBar').val().toLowerCase();
                let searchResultsHtml = '';

                $.getJSON('api/Products.json', function(products) {
                    $.each(products, function(productId, product) {
                        if (product.productDescription.toLowerCase().includes(searchTerm)) {
                            searchResultsHtml += `
                                <div class="search-result">
                                    <p><strong>${product.productDescription}</strong> - $${product.productPrice}</p>
                                    <button class="btn btn-outline-dark" onclick="angular.element(this).scope().addToCart('${productId}')">Add to Cart</button>
                                </div>
                            `;
                        }
                    });
                    $('#searchResults').html(searchResultsHtml || '<p>No products found!</p>');
                });
            });
        });
    </script>
</body>
</html>
